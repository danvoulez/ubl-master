name: UBL Self-Maintaining Pipeline

on:
  push:
    branches: [main]
    paths-ignore: ['docs/**', 'README.md', '*.md']
  pull_request:
    branches: [main]
    paths-ignore: ['docs/**', 'README.md', '*.md']

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  knock:
    name: "üö™ KNOCK"
    runs-on: ubuntu-latest
    outputs:
      affected: ${{ steps.detect.outputs.affected }}
      breaking: ${{ steps.detect.outputs.breaking }}
      scope: ${{ steps.detect.outputs.scope }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changes
        id: detect
        run: |
          chmod +x scripts/detect_affected.sh
          tmp_out="$(mktemp)"
          ./scripts/detect_affected.sh | tee "$tmp_out"
          grep -E '^(affected|breaking|scope)=' "$tmp_out" >> "$GITHUB_OUTPUT"

      - name: Report Scope
        run: |
          echo "üìä Scope: ${{ steps.detect.outputs.scope }}"
          echo "üì¶ Affected: ${{ steps.detect.outputs.affected }}"
          echo "‚ö†Ô∏è  Breaking: ${{ steps.detect.outputs.breaking }}"

  wa:
    name: "üëª WA"
    needs: knock
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        id: toolchain
        with:
          components: clippy, rustfmt

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/
            ~/.cargo/git/
            target/
          key: ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-
            ${{ runner.os }}-

      - name: Format Check
        run: cargo fmt --all -- --check

      - name: Build
        run: cargo build --workspace --all-targets

      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  tr:
    name: "‚ö° TR"
    needs: wa
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        id: toolchain

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/
            ~/.cargo/git/
            target/
          key: ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-

      - name: Unit Tests
        run: cargo test --workspace --lib

      - name: Integration Tests
        run: cargo test --workspace --test '*'

      - name: Gate Contract Tests
        run: cargo test -p ubl_gate

      - name: Doc Tests
        run: cargo test --workspace --doc

      - name: Property Tests
        run: cargo test --workspace --features property-tests
        continue-on-error: true

      - name: UNC-1 Strict Smoke
        run: |
          REQUIRE_UNC1_NUMERIC=true F64_IMPORT_MODE=reject \
            cargo test -p ubl_runtime --lib 'knock::tests::knock_require_unc1_numeric_rejects_raw_float_literals' -- --exact
          REQUIRE_UNC1_NUMERIC=true F64_IMPORT_MODE=reject \
            cargo test -p ubl_runtime --lib 'knock::tests::knock_require_unc1_numeric_accepts_num_atoms' -- --exact

  execute:
    name: "üîß EXECUTE"
    needs: tr
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Security Audit
        run: |
          cargo install cargo-audit --locked || true
          cargo audit

      - name: Semver Check
        if: github.event_name == 'pull_request'
        run: |
          cargo install cargo-semver-checks --locked || true
          cargo semver-checks check-release --baseline-rev origin/main
        continue-on-error: true

  rollout_check:
    name: "üö¶ Rollout Check (${{ matrix.os }})"
    needs: tr
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build Gate Binary
        run: cargo build -p ubl_gate

      - name: Rollout P0‚ÜíP1 Preflight
        shell: bash
        run: |
          if command -v sha256sum >/dev/null 2>&1; then
            RUNTIME_HASH="$(sha256sum target/debug/ubl_gate | cut -d' ' -f1)"
          else
            RUNTIME_HASH="$(shasum -a 256 target/debug/ubl_gate | awk '{print $1}')"
          fi
          export RUNTIME_HASH
          make rollout-check

  simkit_stx:
    name: "üß™ SIMKIT-STX"
    needs: tr
    if: ${{ needs.tr.result == 'success' }}
    runs-on: ubuntu-latest
    env:
      REQUIRE_UNC1_NUMERIC: "true"
      F64_IMPORT_MODE: "reject"
      STX_ENABLED: "1"
      STX_DIFF_PROB: "0.03"
    steps:
      - uses: actions/checkout@v4

      - name: Detect SimRunner
        id: detect_simrunner
        shell: bash
        run: |
          if [[ -f simrunner/main.py ]]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
            echo "SimRunner detected"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "SimRunner not detected; skipping STX run"
          fi

      - uses: dtolnay/rust-toolchain@stable
        if: steps.detect_simrunner.outputs.present == 'true'

      - uses: actions/setup-python@v5
        if: steps.detect_simrunner.outputs.present == 'true'
        with:
          python-version: "3.11"

      - name: Install SimRunner deps
        if: steps.detect_simrunner.outputs.present == 'true'
        run: |
          if [[ -f simrunner/requirements.txt ]]; then
            python -m pip install --upgrade pip
            python -m pip install -r simrunner/requirements.txt
          fi

      - name: Start Gate
        if: steps.detect_simrunner.outputs.present == 'true'
        run: |
          cargo run -p ubl_gate > /tmp/ubl_gate.log 2>&1 &
          echo "GATE_PID=$!" >> "$GITHUB_ENV"

      - name: Wait for Gate Health
        if: steps.detect_simrunner.outputs.present == 'true'
        run: |
          for i in {1..40}; do
            if curl -fsS http://127.0.0.1:4000/healthz >/dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "Gate did not become healthy" >&2
          exit 1

      - name: Run SimRunner STX
        if: steps.detect_simrunner.outputs.present == 'true'
        run: |
          export UBL_GATE_URL="${UBL_GATE_URL:-http://127.0.0.1:4000/v1/chips}"
          export RUN_ID="stx-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          python simrunner/main.py | tee /tmp/simrunner.log

      - name: Assert STX verify has no failures
        if: steps.detect_simrunner.outputs.present == 'true'
        run: |
          if grep -R -nE 'stx/receipt\\.verify[^[:alnum:]]*(false|0)|\"verify\"[[:space:]]*:[[:space:]]*false' /tmp/simrunner.log simrunner 2>/dev/null; then
            echo "Detected failed receipt verification in STX run" >&2
            exit 1
          fi

      - name: Upload STX logs
        if: always() && steps.detect_simrunner.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: simkit-stx-logs
          path: |
            /tmp/ubl_gate.log
            /tmp/simrunner.log

      - name: Stop Gate
        if: always() && steps.detect_simrunner.outputs.present == 'true'
        run: |
          if [[ -n "${GATE_PID:-}" ]]; then
            kill "${GATE_PID}" || true
          fi

  wf:
    name: "‚úÖ WF"
    needs: [knock, wa, tr, execute, rollout_check, simkit_stx]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Evaluate
        id: decision
        run: |
          echo "============================================"
          echo "  UBL PIPELINE ‚Äî WRITE-FINISHED RECEIPT"
          echo "============================================"
          echo ""
          echo "Scope:    ${{ needs.knock.outputs.scope }}"
          echo "Affected: ${{ needs.knock.outputs.affected }}"
          echo "Breaking: ${{ needs.knock.outputs.breaking }}"
          echo ""
          echo "Results:"
          echo "  WA:      ${{ needs.wa.result }}"
          echo "  TR:      ${{ needs.tr.result }}"
          echo "  EXECUTE: ${{ needs.execute.result }}"
          echo "  SIMKIT:  ${{ needs.simkit_stx.result }}"
          echo ""

          if [[ "${{ needs.wa.result }}" == "success" && \
                "${{ needs.tr.result }}" == "success" && \
                "${{ needs.execute.result }}" == "success" && \
                ("${{ needs.simkit_stx.result }}" == "success" || "${{ needs.simkit_stx.result }}" == "skipped") ]]; then
            echo "decision=ALLOW" >> "$GITHUB_ENV"
            echo "üü¢ DECISION: ALLOW"
          else
            echo "decision=DENY" >> "$GITHUB_ENV"
            echo "üî¥ DECISION: DENY"
            exit 1
          fi

      - name: Generate Signed Receipt
        if: always()
        run: |
          # Generate receipt
          cat > wf_receipt.json <<EOF
          {
            "type": "ubl/ci_receipt",
            "decision": "${{ env.decision }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "scope": "${{ needs.knock.outputs.scope }}",
            "stages": {
              "wa": "${{ needs.wa.result }}",
              "tr": "${{ needs.tr.result }}",
              "execute": "${{ needs.execute.result }}",
              "simkit_stx": "${{ needs.simkit_stx.result }}"
            },
            "pipeline": "WA‚ÜíTR‚ÜíWF",
            "runtime": "github-actions",
            "autopoietic": true
          }
          EOF

          # Sign with Ed25519 if ublx CLI available
          if command -v ublx &> /dev/null; then
            ublx sign wf_receipt.json --output wf_receipt.jws
            echo "‚úÖ Receipt cryptographically signed"
          else
            echo "‚ö†Ô∏è  ublx CLI not available, skipping signature"
            cp wf_receipt.json wf_receipt.jws
          fi

          echo "üìã Generated UBL Receipt:"
          cat wf_receipt.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: wf-receipt
          path: wf_receipt.jws
          retention-days: 30

  publish:
    name: "üì¶ Publish"
    needs: wf
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'release:')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Publish Crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          chmod +x scripts/publish_ordered.sh
          ./scripts/publish_ordered.sh
